<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 ç¶²è·¯ä¼ºæœå™¨æ§åˆ¶å°</title>
    <style>
      :root {
        --primary: #667eea;
        --secondary: #764ba2;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #343a40;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card h2 {
        color: var(--dark);
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary);
        font-size: 1.4em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-grid {
        display: grid;
        gap: 12px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 15px;
        background: var(--light);
        border-radius: 8px;
        border-left: 4px solid var(--primary);
      }

      .status-label {
        font-weight: 600;
        color: var(--dark);
      }

      .status-value {
        font-family: "Courier New", monospace;
        font-weight: 600;
      }

      .btn-group {
        display: grid;
        gap: 15px;
        margin-top: 20px;
      }

      .btn {
        padding: 15px;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1em;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: var(--secondary);
        color: white;
      }

      .btn-warning {
        background: var(--warning);
        color: var(--dark);
      }

      .info-box {
        background: var(--light);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .connection-status {
        padding: 15px;
        background: var(--light);
        border-radius: 8px;
        margin-top: 20px;
        line-height: 1.6;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-box {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 15px;
        border-radius: 8px;
        color: white;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        margin: 5px 0;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸŒ ESP32 ç¶²è·¯ä¼ºæœå™¨</h1>
        <p id="active-ip">è¼‰å…¥ä¸­...</p>
      </div>

      <div class="dashboard">
        <div class="card">
          <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹</h2>
          <div id="status-content" class="status-grid">
            <div class="status-item">
              <span class="status-label">è¼‰å…¥ä¸­...</span>
              <span class="status-value">è«‹ç¨å€™</span>
              <span class="status-label">WiFiç‹€æ…‹</span>
              <span class="status-value" id="wifi-status">
                <span id="wifi-connection-status">æœªé€£æ¥</span>
                <span
                  id="wifi-ip-display"
                  style="
                    display: none;
                    margin-left: 10px;
                    font-size: 0.9em;
                    color: #28a745;
                  "
                ></span>
              </span>
            </div>
          </div>

          <div class="connection-status" id="connection-status">
            è¼‰å…¥é€£æ¥ç‹€æ…‹...
          </div>

          <div class="stats">
            <div class="stat-box">
              <div class="stat-value" id="client-count">0</div>
              <div class="stat-label">é€£ç·šå®¢æˆ¶ç«¯</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="uptime">0</div>
              <div class="stat-label">é‹è¡Œæ™‚é–“</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>âš™ï¸ ç³»çµ±æ§åˆ¶</h2>
          <div class="btn-group">
            <a href="/network-config" class="btn btn-primary"> ğŸ”§ ç¶²è·¯è¨­å®š </a>
            <button onclick="restartSystem()" class="btn btn-warning">
              ğŸ”„ é‡å•Ÿç³»çµ±
            </button>
          </div>

          <h2 style="margin-top: 25px">ğŸ“ˆ å³æ™‚ç›£æ§</h2>
          <div class="btn-group">
            <button onclick="startMonitoring()" class="btn btn-primary">
              â–¶ï¸ é–‹å§‹ç›£æ§
            </button>
            <button onclick="stopMonitoring()" class="btn btn-secondary">
              â¸ï¸ åœæ­¢ç›£æ§
            </button>
          </div>

          <div class="info-box">
            <p><strong>TCPä¼ºæœå™¨:</strong> Port 2024</p>
            <p><strong>Webä»‹é¢:</strong> Port 80</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let monitorInterval;
      let startTime = Date.now();

      // æ›´æ–°ç‹€æ…‹
      async function updateStatus() {
        try {
          const response = await fetch("/status");
          const data = await response.json();

          // æ›´æ–°ç‹€æ…‹å…§å®¹
          const statusHTML = `
                    <div class="status-item">
                        <span class="status-label">ç¶²è·¯æ¨¡å¼</span>
                        <span class="status-value">${data.network_mode}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">APæ¨¡å¼</span>
                        <span class="status-value">${data.ap_active ? "âœ… é‹è¡Œä¸­" : "âŒ å·²åœæ­¢"}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ä¹™å¤ªç¶²</span>
                        <span class="status-value">${data.eth_connected ? "âœ… å·²é€£æ¥" : "âŒ æœªé€£æ¥"}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">WiFi</span>
                        <span class="status-value">${data.wifi_connected ? "âœ… å·²é€£æ¥" : "âŒ æœªé€£æ¥"}</span>
                    </div>
                `;

          document.getElementById("status-content").innerHTML = statusHTML;
          document.getElementById("connection-status").innerHTML =
            data.connection_status;
          document.getElementById("active-ip").textContent =
            `è¨ªå•åœ°å€: http://${data.active_ip}`;
          document.getElementById("client-count").textContent =
            data.client_count;

          // æ›´æ–°é‹è¡Œæ™‚é–“
          const uptime = Math.floor((Date.now() - startTime) / 1000);
          document.getElementById("uptime").textContent = `${uptime}ç§’`;

          // æ›´æ–°WiFiç‹€æ…‹é¡¯ç¤º
          const wifiStatus = document.getElementById("wifi-connection-status");
          const wifiIpDisplay = document.getElementById("wifi-ip-display");

          if (data.wifi_connected) {
            wifiStatus.textContent = "âœ… å·²é€£æ¥";
            wifiIpDisplay.textContent = data.wifi_ip;
            wifiIpDisplay.style.display = "inline";

            // å¦‚æœæœ‰IPï¼Œæ›´æ–°ä¸»æ¨™é¡Œ
            if (data.active_ip && data.active_ip !== "æœªé€£æ¥") {
              document.getElementById("active-ip").textContent =
                `è¨ªå•åœ°å€: http://${data.active_ip} (WiFi)`;
            }
          } else {
            wifiStatus.textContent = "âŒ æœªé€£æ¥";
            wifiIpDisplay.style.display = "none";
          }
        } catch (error) {
          console.error("ç²å–ç‹€æ…‹å¤±æ•—:", error);
          document.getElementById("connection-status").innerHTML =
            "âŒ ç„¡æ³•ç²å–ç‹€æ…‹è³‡è¨Šï¼Œè«‹æª¢æŸ¥é€£æ¥";
        }
      }

      // é–‹å§‹ç›£æ§
      function startMonitoring() {
        if (monitorInterval) clearInterval(monitorInterval);
        monitorInterval = setInterval(updateStatus, 2000);
        updateStatus();
        alert("ç›£æ§å·²é–‹å§‹ï¼Œæ¯2ç§’æ›´æ–°ä¸€æ¬¡ç‹€æ…‹");
      }

      // åœæ­¢ç›£æ§
      function stopMonitoring() {
        if (monitorInterval) {
          clearInterval(monitorInterval);
          monitorInterval = null;
          alert("ç›£æ§å·²åœæ­¢");
        }
      }

      // é‡å•Ÿç³»çµ±
      async function restartSystem() {
        if (confirm("ç¢ºå®šè¦é‡æ–°å•Ÿå‹•ç³»çµ±å—ï¼Ÿé€™æœƒä¸­æ–·æ‰€æœ‰é€£ç·šã€‚")) {
          try {
            const response = await fetch("/restart", {
              method: "POST",
            });

            const result = await response.json();
            alert(result.message);

            setTimeout(() => {
              location.reload();
            }, 3000);
          } catch (error) {
            alert("é‡å•ŸæŒ‡ä»¤å·²ç™¼é€ï¼Œç³»çµ±å°‡é‡æ–°å•Ÿå‹•...");
            setTimeout(() => {
              location.reload();
            }, 3000);
          }
        }
      }

      // é é¢è¼‰å…¥æ™‚è‡ªå‹•é–‹å§‹ç›£æ§
      window.onload = function () {
        startMonitoring();
      };
    </script>
  </body>
</html>
