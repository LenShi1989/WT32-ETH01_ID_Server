<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¶²è·¯è¨­å®š - ESP32</title>
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.3em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header a {
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .header a:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .setup-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .setup-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .progress-step {
      text-align: center;
      flex: 1;
      position: relative;
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s ease;
    }

    .progress-step.active .step-number {
      background: var(--primary);
      color: white;
    }

    .step-title {
      font-size: 0.9em;
      color: #666;
    }

    .progress-step.active .step-title {
      color: var(--primary);
      font-weight: 600;
    }

    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid var(--primary);
    }

    .form-section h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-check {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .form-check-input {
      margin-right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .form-check-label {
      font-weight: 500;
      color: #333;
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }

    .btn {
      padding: 15px 30px;
      text-align: center;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-width: 150px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .static-ip-fields {
      display: none;
      animation: fadeIn 0.3s ease;
      margin-top: 15px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mode-description {
      background: rgba(102, 126, 234, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid var(--primary);
    }

    .mode-description h4 {
      color: var(--primary);
      margin-bottom: 8px;
    }

    .mode-description p {
      color: #555;
      line-height: 1.5;
      font-size: 0.95em;
    }

    .success-message {
      text-align: center;
      padding: 30px;
    }

    .success-icon {
      font-size: 4em;
      color: var(--success);
      margin-bottom: 20px;
    }

    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23667eea' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      padding-right: 40px;
    }

    .wifi-scanner {
      margin-top: 20px;
    }

    .scan-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }

    .scan-btn:hover {
      background: var(--secondary);
    }

    .wifi-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
      margin-bottom: 20px;
    }

    .wifi-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .wifi-item:hover {
      background: #f8f9fa;
    }

    .wifi-item.selected {
      background: #e8f4fd;
      border-left: 3px solid var(--primary);
    }

    .wifi-icon {
      font-size: 1.5em;
      color: #666;
      width: 30px;
      text-align: center;
    }

    .wifi-info {
      flex: 1;
    }

    .wifi-ssid {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .wifi-details {
      display: flex;
      gap: 15px;
      font-size: 0.9em;
      color: #666;
    }

    .signal-strength {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .signal-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 20px;
    }

    .signal-bar {
      width: 4px;
      background: #ddd;
      border-radius: 1px;
    }

    .signal-bar.active {
      background: var(--success);
    }

    .wifi-encryption {
      padding: 2px 8px;
      background: #f0f0f0;
      border-radius: 10px;
      font-size: 0.8em;
    }

    .connection-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }

    .connection-form.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .password-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .password-input input {
      flex: 1;
    }

    .connect-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .connect-btn:hover {
      background: #218838;
    }

    .connection-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }

    .connection-status.show {
      display: block;
    }

    .status-connecting {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .status-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60%,
      100% {
        content: '...';
      }
    }

    .refresh-btn {
      background: transparent;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 1.2em;
      padding: 5px;
      margin-left: 10px;
    }

    .current-connection {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--success);
    }

    .current-connection h4 {
      margin: 0 0 10px 0;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .disconnect-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .disconnect-btn:hover {
      background: #c82333;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1><span>ğŸ”§</span> ç¶²è·¯è¨­å®šç²¾éˆ</h1>
      <a href="/"><span>â†</span> è¿”å›ä¸»é </a>
    </div>

    <div class="setup-container">
      <div class="setup-progress">
        <div class="progress-step active" id="step1">
          <div class="step-number">1</div>
          <div class="step-title">åŸºæœ¬è¨­å®š</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="step-number">2</div>
          <div class="step-title">WiFiè¨­å®š</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="step-number">3</div>
          <div class="step-title">å®Œæˆ</div>
        </div>
      </div>

      <div id="setup-content">
        <!-- æ­¥é©Ÿ1ï¼šåŸºæœ¬è¨­å®š -->
        <div id="step1-content" class="form-content">
          <div class="form-section">
            <h3><span>ğŸ·ï¸</span> è¨­å‚™åŸºæœ¬è³‡è¨Š</h3>
            <div class="form-group">
              <label for="device_name"><span>ğŸ“</span> è¨­å‚™åç¨±</label>
              <input type="text" id="device_name" name="device_name" class="form-control"
                placeholder="è¼¸å…¥è¨­å‚™åç¨±ï¼ˆå¦‚ï¼šå®¢å»³ESP32ï¼‰" value="">
            </div>

            <div class="form-group">
              <label for="ap_ssid"><span>ğŸ“¡</span> APç¶²è·¯åç¨±</label>
              <input type="text" id="ap_ssid" name="ap_ssid" class="form-control" placeholder="è¼¸å…¥APç¶²è·¯åç¨±" value="">
              <small style="color: #666; margin-top: 5px; display: block;">
                æ ¼å¼: ESP32_ + MACæœ€å¾Œ2ç¢¼ (ç„¡å¯†ç¢¼)
              </small>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" id="next-step-1" class="btn btn-primary">
              ä¸‹ä¸€æ­¥ <span>â†’</span>
            </button>
          </div>
        </div>

        <!-- æ­¥é©Ÿ2ï¼šWiFiè¨­å®š -->
        <div id="step2-content" class="form-content" style="display: none;">
          <div class="form-section">
            <h3><span>ğŸ“¶</span> WiFiè¨­å®š</h3>

            <!-- ç•¶å‰é€£æ¥ç‹€æ…‹ -->
            <div id="current-connection" class="current-connection" style="display: none;">
              <h4><span>âœ…</span> å·²é€£æ¥</h4>
              <p><strong>SSID:</strong> <span id="connected-ssid"></span></p>
              <p><strong>IPåœ°å€:</strong> <span id="connected-ip"></span></p>
              <p><strong>è¨Šè™Ÿå¼·åº¦:</strong> <span id="connected-rssi"></span> dBm</p>
              <button type="button" id="disconnect-btn" class="disconnect-btn">
                <span>âŒ</span> æ–·é–‹é€£æ¥
              </button>
            </div>

            <!-- WiFiæƒæå€åŸŸ -->
            <div class="wifi-scanner">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                  <span>ğŸ”</span> å¯ç”¨çš„WiFiç¶²è·¯
                </h4>
                <button type="button" id="scan-wifi-btn" class="scan-btn">
                  <span>ğŸ”„</span> æƒæç¶²è·¯
                </button>
              </div>

              <div id="wifi-list" class="wifi-list">
                <div class="loading" id="wifi-loading">æƒæä¸­</div>
                <!-- WiFiåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
              </div>
            </div>

            <!-- é€£æ¥è¡¨å–® -->
            <div id="connection-form" class="connection-form">
              <h4>é€£æ¥è‡³: <span id="selected-ssid"></span></h4>
              <div class="form-group">
                <label for="wifi_password"><span>ğŸ”</span> WiFiå¯†ç¢¼</label>
                <div class="password-input">
                  <input type="password" id="wifi_password" name="wifi_password" class="form-control"
                    placeholder="è¼¸å…¥WiFiå¯†ç¢¼">
                  <button type="button" id="show-password" class="btn btn-secondary" style="padding: 0 15px;">
                    é¡¯ç¤º
                  </button>
                </div>
              </div>
              <div class="btn-group" style="justify-content: flex-start; margin-top: 15px;">
                <button type="button" id="connect-btn" class="connect-btn">
                  <span>ğŸ”—</span> é€£æ¥
                </button>
                <button type="button" id="cancel-connect" class="btn btn-secondary">
                  å–æ¶ˆ
                </button>
              </div>
            </div>

            <!-- é€£æ¥ç‹€æ…‹ -->
            <div id="connection-status" class="connection-status"></div>
          </div>

          <div class="form-section">
            <h3><span>ğŸ”Œ</span> ä¹™å¤ªç¶²è¨­å®š</h3>
            <div class="form-check">
              <input type="checkbox" id="eth_enabled" name="eth_enabled" class="form-check-input" checked>
              <label for="eth_enabled" class="form-check-label">å•Ÿç”¨ä¹™å¤ªç¶²</label>
            </div>

            <div class="form-check">
              <input type="checkbox" id="eth_dhcp" name="eth_dhcp" class="form-check-input" checked>
              <label for="eth_dhcp" class="form-check-label">è‡ªå‹•å–å¾—IP (DHCP)</label>
            </div>

            <div id="staticIPFields" class="static-ip-fields">
              <div class="form-row">
                <div class="form-group">
                  <label for="eth_static_ip"><span>ğŸ“</span> å›ºå®šIPåœ°å€</label>
                  <input type="text" id="eth_static_ip" name="eth_static_ip" class="form-control"
                    placeholder="192.168.1.100" value="">
                </div>

                <div class="form-group">
                  <label for="eth_gateway"><span>ğŸšª</span> é–˜é“å™¨</label>
                  <input type="text" id="eth_gateway" name="eth_gateway" class="form-control" placeholder="192.168.1.1"
                    value="">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="eth_subnet"><span>ğŸŒ</span> å­ç¶²è·¯é®ç½©</label>
                  <input type="text" id="eth_subnet" name="eth_subnet" class="form-control" placeholder="255.255.255.0"
                    value="">
                </div>

                <div class="form-group">
                  <label for="eth_dns1"><span>ğŸ”</span> ä¸»è¦DNS</label>
                  <input type="text" id="eth_dns1" name="eth_dns1" class="form-control" placeholder="8.8.8.8" value="">
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3><span>âš™ï¸</span> ç¶²è·¯é‹ä½œæ¨¡å¼</h3>
            <div class="form-group">
              <label for="network_mode"><span>ğŸ”„</span> é¸æ“‡ç¶²è·¯æ¨¡å¼</label>
              <select id="network_mode" name="network_mode" class="form-control">
                <option value="0" selected>APæ¨¡å¼ (åƒ…WiFiç†±é»)</option>
                <option value="1">åƒ…ä¹™å¤ªç¶²</option>
                <option value="2">åƒ…WiFi</option>
                <option value="3">é›™ç¶²è·¯æ¨¡å¼</option>
                <option value="4">ä¹™å¤ªç¶²å„ªå…ˆ</option>
                <option value="5">WiFiå„ªå…ˆ</option>
              </select>
            </div>

            <div class="mode-description" id="mode-description">
              <h4>APæ¨¡å¼</h4>
              <p>è¨­å‚™ä½œç‚ºWiFiç†±é»ï¼Œå…¶ä»–è¨­å‚™å¯é€£æ¥åˆ°æ­¤ç†±é»é€²è¡Œè¨­å®šæˆ–ä½¿ç”¨æœå‹™ã€‚é©åˆé¦–æ¬¡è¨­å®šæˆ–æ²’æœ‰å…¶ä»–ç¶²è·¯çš„æƒ…æ³ã€‚</p>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" id="prev-step-2" class="btn btn-secondary">
              <span>â†</span> ä¸Šä¸€æ­¥
            </button>
            <button type="button" id="save-config-btn" class="btn btn-primary">
              ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨è¨­å®š
            </button>
          </div>
        </div>

        <!-- æ­¥é©Ÿ3ï¼šå®Œæˆ -->
        <div id="step3-content" class="form-content" style="display: none;">
          <div class="success-message">
            <div class="success-icon">âœ…</div>
            <h2>è¨­å®šå®Œæˆï¼</h2>
            <p style="margin: 20px 0; color: #555; line-height: 1.6;">
              æ‚¨çš„è¨­å®šå·²æˆåŠŸå„²å­˜ã€‚è¨­å‚™å°‡è‡ªå‹•é‡æ–°å•Ÿå‹•ä¸¦å¥—ç”¨æ–°çš„ç¶²è·¯è¨­å®šã€‚
            </p>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 25px 0;">
              <p><strong>è«‹æ³¨æ„ï¼š</strong></p>
              <ul style="text-align: left; margin: 15px 0; padding-left: 20px;">
                <li>è¨­å‚™å°‡åœ¨3ç§’å¾Œè‡ªå‹•é‡æ–°å•Ÿå‹•</li>
                <li>é‡æ–°å•Ÿå‹•å¾Œï¼Œè«‹é€£æ¥åˆ°æ‚¨è¨­å®šçš„ç¶²è·¯</li>
                <li>ä½¿ç”¨æ–°çš„IPåœ°å€è¨ªå•è¨­å‚™æ§åˆ¶å°</li>
              </ul>
            </div>
            <div id="countdown" style="font-size: 1.2em; color: var(--primary); margin: 20px 0;">
              é‡æ–°å•Ÿå‹•å€’æ•¸: <span id="countdown-number">3</span> ç§’
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šæ•¸
    let currentStep = 1;
    let isFirstSetup = true;
    let selectedWiFi = null;
    let currentConnection = null;
    let wifiScanInterval = null;

    // æ¨¡å¼æè¿°å°æ‡‰
    const modeDescriptions = {
      0: { title: "APæ¨¡å¼", description: "è¨­å‚™ä½œç‚ºWiFiç†±é»ï¼Œå…¶ä»–è¨­å‚™å¯é€£æ¥åˆ°æ­¤ç†±é»é€²è¡Œè¨­å®šæˆ–ä½¿ç”¨æœå‹™ã€‚é©åˆé¦–æ¬¡è¨­å®šæˆ–æ²’æœ‰å…¶ä»–ç¶²è·¯çš„æƒ…æ³ã€‚" },
      1: { title: "åƒ…ä¹™å¤ªç¶²", description: "åªä½¿ç”¨RJ45ä¹™å¤ªç¶²é€£æ¥ï¼Œéœ€è¦é€£æ¥ç¶²è·¯ç·šã€‚é©åˆå›ºå®šä½ç½®ä¸”æœ‰ç·šç¶²è·¯ç©©å®šçš„ç’°å¢ƒã€‚" },
      2: { title: "åƒ…WiFi", description: "åªä½¿ç”¨ç„¡ç·šWiFié€£æ¥ï¼Œéœ€è¦è¨­å®šWiFiç¶²è·¯ã€‚é©åˆç„¡ç·šç’°å¢ƒæˆ–ç§»å‹•ä½¿ç”¨ã€‚" },
      3: { title: "é›™ç¶²è·¯æ¨¡å¼", description: "åŒæ™‚ä½¿ç”¨ä¹™å¤ªç¶²å’ŒWiFiï¼Œå…©å€‹ç¶²è·¯éƒ½å¯é€£ç·šã€‚é©åˆéœ€è¦é«˜å¯ç”¨æ€§çš„ç’°å¢ƒã€‚" },
      4: { title: "ä¹™å¤ªç¶²å„ªå…ˆ", description: "å„ªå…ˆä½¿ç”¨ä¹™å¤ªç¶²ï¼Œç•¶ä¹™å¤ªç¶²æ–·ç·šæ™‚è‡ªå‹•åˆ‡æ›åˆ°WiFiã€‚é©åˆæœ‰ç·šç‚ºä¸»ã€ç„¡ç·šç‚ºå‚™ç”¨çš„ç’°å¢ƒã€‚" },
      5: { title: "WiFiå„ªå…ˆ", description: "å„ªå…ˆä½¿ç”¨WiFiï¼Œç•¶WiFiæ–·ç·šæ™‚è‡ªå‹•åˆ‡æ›åˆ°ä¹™å¤ªç¶²ã€‚é©åˆç„¡ç·šç‚ºä¸»ã€æœ‰ç·šç‚ºå‚™ç”¨çš„ç’°å¢ƒã€‚" }
    };

    // DHCPåˆ‡æ›è™•ç†
    const dhcpCheckbox = document.getElementById('eth_dhcp');
    const staticFields = document.getElementById('staticIPFields');

    function toggleStaticFields() {
      if (dhcpCheckbox.checked) {
        staticFields.style.display = 'none';
      } else {
        staticFields.style.display = 'block';
      }
    }

    // ç¶²è·¯æ¨¡å¼é¸æ“‡è™•ç†
    const networkModeSelect = document.getElementById('network_mode');
    const modeDescription = document.getElementById('mode-description');

    function updateModeDescription() {
      const mode = parseInt(networkModeSelect.value);
      if (modeDescriptions[mode]) {
        modeDescription.innerHTML = `
                    <h4>${modeDescriptions[mode].title}</h4>
                    <p>${modeDescriptions[mode].description}</p>
                `;
      }
    }

    // æ­¥é©Ÿåˆ‡æ›å‡½æ•¸
    function nextStep(step) {
      console.log('ä¸‹ä¸€æ­¥æŒ‰éˆ•è¢«é»æ“Šï¼Œç›®æ¨™æ­¥é©Ÿ:', step);

      if (step === 2) {
        // é©—è­‰æ­¥é©Ÿ1çš„è¼¸å…¥
        const deviceName = document.getElementById('device_name').value.trim();
        const apSsid = document.getElementById('ap_ssid').value.trim();

        if (!deviceName) {
          alert('è«‹è¼¸å…¥è¨­å‚™åç¨±');
          return;
        }

        if (!apSsid) {
          alert('è«‹è¼¸å…¥APç¶²è·¯åç¨±');
          return;
        }

        // è¼‰å…¥ç•¶å‰é€£æ¥ç‹€æ…‹
        loadCurrentConnection();
      }

      showStep(step);
    }

    function prevStep(step) {
      console.log('ä¸Šä¸€æ­¥æŒ‰éˆ•è¢«é»æ“Šï¼Œç›®æ¨™æ­¥é©Ÿ:', step);
      showStep(step);
    }

    function showStep(step) {
      console.log('é¡¯ç¤ºæ­¥é©Ÿ:', step);

      // éš±è—æ‰€æœ‰æ­¥é©Ÿå…§å®¹
      document.querySelectorAll('.form-content').forEach(el => {
        el.style.display = 'none';
      });

      // é‡ç½®æ‰€æœ‰æ­¥é©Ÿç‹€æ…‹
      document.querySelectorAll('.progress-step').forEach(el => {
        el.classList.remove('active');
      });

      // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
      const stepContent = document.getElementById(`step${step}-content`);
      if (stepContent) {
        stepContent.style.display = 'block';
        const stepIndicator = document.getElementById(`step${step}`);
        if (stepIndicator) {
          stepIndicator.classList.add('active');
        }
        currentStep = step;

        // å¦‚æœæ˜¯æ­¥é©Ÿ2ï¼Œè‡ªå‹•æƒæWiFi
        if (step === 2) {
          setTimeout(() => {
            scanWiFi();
          }, 500);
        }
      } else {
        console.error('æ‰¾ä¸åˆ°æ­¥é©Ÿå…§å®¹:', step);
      }
    }

    // è¼‰å…¥ç•¶å‰é€£æ¥ç‹€æ…‹
    async function loadCurrentConnection() {
      try {
        const response = await fetch('/status');
        const data = await response.json();

        const currentConn = document.getElementById('current-connection');
        const connectedSsid = document.getElementById('connected-ssid');
        const connectedIp = document.getElementById('connected-ip');
        const connectedRssi = document.getElementById('connected-rssi');

        if (data.wifi_connected && data.wifi_ssid) {
          currentConn.style.display = 'block';
          connectedSsid.textContent = data.wifi_ssid;
          connectedIp.textContent = data.wifi_ip;
          connectedRssi.textContent = data.wifi_rssi;
          currentConnection = data.wifi_ssid;
        } else {
          currentConn.style.display = 'none';
          currentConnection = null;
        }

        isFirstSetup = data.first_setup === true || data.first_setup === 'true';

      } catch (error) {
        console.error('è¼‰å…¥ç•¶å‰é€£æ¥ç‹€æ…‹å¤±æ•—:', error);
      }
    }

    // æƒæWiFi
    async function scanWiFi() {
      const wifiList = document.getElementById('wifi-list');
      wifiList.innerHTML = '<div class="loading">æƒæWiFiç¶²è·¯ä¸­</div>';

      try {
        const response = await fetch('/scan-wifi');
        const data = await response.json();

        if (data.networks && data.networks.length > 0) {
          renderWiFiList(data.networks);
        } else {
          wifiList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æœªæ‰¾åˆ°ä»»ä½•WiFiç¶²è·¯</div>';
        }
      } catch (error) {
        console.error('æƒæWiFiå¤±æ•—:', error);
        wifiList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">æƒæå¤±æ•—ï¼Œè«‹é‡è©¦</div>';
      }
    }

    // æ¸²æŸ“WiFiåˆ—è¡¨
    function renderWiFiList(networks) {
      const wifiList = document.getElementById('wifi-list');
      wifiList.innerHTML = '';

      // æŒ‰è¨Šè™Ÿå¼·åº¦æ’åº
      networks.sort((a, b) => b.rssi - a.rssi);

      networks.forEach(network => {
        const wifiItem = document.createElement('div');
        wifiItem.className = 'wifi-item';
        if (selectedWiFi === network.ssid) {
          wifiItem.classList.add('selected');
        }
        if (currentConnection === network.ssid) {
          wifiItem.style.background = '#e8f5e9';
        }

        // è¨ˆç®—è¨Šè™Ÿæ¢æ•¸
        const quality = network.quality || 0;
        const bars = Math.min(4, Math.floor(quality / 25));

        // å»ºç«‹è¨Šè™Ÿæ¢HTML
        let signalBarsHtml = '';
        for (let i = 0; i < 4; i++) {
          const height = (i + 1) * 5;
          const isActive = i < bars;
          signalBarsHtml += `<div class="signal-bar ${isActive ? 'active' : ''}" style="height: ${height}px"></div>`;
        }

        wifiItem.innerHTML = `
                    <div class="wifi-icon">
                        ${getWiFiIcon(quality, network.encryption)}
                    </div>
                    <div class="wifi-info">
                        <div class="wifi-ssid">${escapeHtml(network.ssid)}</div>
                        <div class="wifi-details">
                            <div class="signal-strength">
                                <div class="signal-bars">${signalBarsHtml}</div>
                                <span>${quality}%</span>
                            </div>
                            <div class="wifi-channel">é »é“ ${network.channel}</div>
                            <div class="wifi-encryption">${network.encryption_str || 'æœªçŸ¥'}</div>
                        </div>
                    </div>
                `;

        wifiItem.addEventListener('click', () => {
          selectWiFi(network);
        });

        wifiList.appendChild(wifiItem);
      });
    }

    // ç²å–WiFiåœ–ç¤º
    function getWiFiIcon(quality, encryption) {
      if (encryption === 0) { // WIFI_AUTH_OPEN
        return 'ğŸŒ';
      }

      if (quality >= 75) return 'ğŸ“¶';
      if (quality >= 50) return 'ğŸ“¶';
      if (quality >= 25) return 'ğŸ“¶';
      return 'ğŸ“¶';
    }

    // é¸æ“‡WiFi
    function selectWiFi(network) {
      selectedWiFi = network.ssid;

      // æ›´æ–°é¸æ“‡ç‹€æ…‹
      document.querySelectorAll('.wifi-item').forEach(item => {
        item.classList.remove('selected');
      });

      event.currentTarget.classList.add('selected');

      // é¡¯ç¤ºé€£æ¥è¡¨å–®
      const connectionForm = document.getElementById('connection-form');
      const selectedSsid = document.getElementById('selected-ssid');
      const passwordInput = document.getElementById('wifi_password');

      selectedSsid.textContent = network.ssid;
      passwordInput.value = '';
      passwordInput.type = 'password';
      connectionForm.classList.add('show');

      // æ»¾å‹•åˆ°è¡¨å–®
      connectionForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // é€£æ¥WiFi
    async function connectToWiFi() {
      const ssid = selectedWiFi;
      const password = document.getElementById('wifi_password').value;

      if (!ssid) {
        alert('è«‹é¸æ“‡ä¸€å€‹WiFiç¶²è·¯');
        return;
      }

      if (!password && document.getElementById('selected-ssid').textContent !== 'é–‹æ”¾ç¶²è·¯') {
        alert('è«‹è¼¸å…¥WiFiå¯†ç¢¼');
        return;
      }

      const statusDiv = document.getElementById('connection-status');
      statusDiv.innerHTML = '<div class="loading">é€£æ¥ä¸­</div>';
      statusDiv.className = 'connection-status show status-connecting';

      try {
        const response = await fetch('/connect-wifi', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ssid, password })
        });

        const result = await response.json();

        if (result.success) {
          // é–‹å§‹æª¢æŸ¥é€£æ¥ç‹€æ…‹
          checkConnectionStatus(ssid);
        } else {
          statusDiv.innerHTML = `<p>âŒ ${result.message || 'é€£æ¥å¤±æ•—'}</p>`;
          statusDiv.className = 'connection-status show status-error';
        }
      } catch (error) {
        console.error('é€£æ¥WiFiå¤±æ•—:', error);
        statusDiv.innerHTML = '<p>âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>';
        statusDiv.className = 'connection-status show status-error';
      }
    }

    // æª¢æŸ¥é€£æ¥ç‹€æ…‹
    async function checkConnectionStatus(ssid) {
      const statusDiv = document.getElementById('connection-status');
      let attempts = 0;
      const maxAttempts = 20; // 10ç§’é˜

      const checkInterval = setInterval(async () => {
        attempts++;

        try {
          const response = await fetch('/wifi-status');
          const data = await response.json();

          if (data.status === 3) { // WL_CONNECTED
            clearInterval(checkInterval);
            statusDiv.innerHTML = `
                            <p>âœ… é€£æ¥æˆåŠŸï¼</p>
                            <p><strong>SSID:</strong> ${data.ssid}</p>
                            <p><strong>IPåœ°å€:</strong> ${data.ip}</p>
                            <p><strong>è¨Šè™Ÿå¼·åº¦:</strong> ${data.rssi} dBm</p>
                        `;
            statusDiv.className = 'connection-status show status-success';

            // æ›´æ–°ç•¶å‰é€£æ¥ç‹€æ…‹
            loadCurrentConnection();

            // éš±è—é€£æ¥è¡¨å–®
            document.getElementById('connection-form').classList.remove('show');

            // é‡æ–°æƒæWiFiåˆ—è¡¨
            setTimeout(() => {
              scanWiFi();
            }, 1000);

          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            statusDiv.innerHTML = '<p>âŒ é€£æ¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥å¯†ç¢¼æ˜¯å¦æ­£ç¢º</p>';
            statusDiv.className = 'connection-status show status-error';
          }
        } catch (error) {
          console.error('æª¢æŸ¥é€£æ¥ç‹€æ…‹å¤±æ•—:', error);
        }
      }, 500);
    }

    // æ–·é–‹WiFié€£æ¥
    async function disconnectWiFi() {
      if (!confirm('ç¢ºå®šè¦æ–·é–‹WiFié€£æ¥å—ï¼Ÿ')) {
        return;
      }

      try {
        // åœæ­¢WiFi
        await fetch('/switch-network', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: 'mode=0' // åˆ‡æ›åˆ°APæ¨¡å¼
        });

        // æ›´æ–°UI
        document.getElementById('current-connection').style.display = 'none';
        currentConnection = null;

        // é‡æ–°æƒæWiFi
        setTimeout(() => {
          scanWiFi();
        }, 1000);

      } catch (error) {
        console.error('æ–·é–‹é€£æ¥å¤±æ•—:', error);
        alert('æ–·é–‹é€£æ¥å¤±æ•—');
      }
    }

    // HTMLè½‰ç¾©
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å„²å­˜è¨­å®šï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
    async function saveConfiguration() {
      console.log('é–‹å§‹å„²å­˜è¨­å®š...');

      // æ”¶é›†è¡¨å–®æ•¸æ“š
      const formData = {
        device_name: document.getElementById('device_name').value.trim(),
        ap_ssid: document.getElementById('ap_ssid').value.trim(),
        ap_password: "",  // ç„¡å¯†ç¢¼
        wifi_ssid: currentConnection || document.getElementById('wifi_ssid').value.trim(),
        wifi_password: "", // å¯†ç¢¼å·²é€šéconnect-wifiè¨­ç½®
        wifi_enabled: true,
        eth_enabled: document.getElementById('eth_enabled').checked,
        eth_dhcp: dhcpCheckbox.checked,
        eth_static_ip: document.getElementById('eth_static_ip').value,
        eth_gateway: document.getElementById('eth_gateway').value,
        eth_subnet: document.getElementById('eth_subnet').value,
        eth_dns1: document.getElementById('eth_dns1').value,
        eth_dns2: "",  // å¯é¸
        network_mode: networkModeSelect.value
      };

      console.log('è¡¨å–®æ•¸æ“š:', formData);

      // é©—è­‰å›ºå®šIP
      if (!dhcpCheckbox.checked) {
        const staticIP = formData.eth_static_ip;
        if (!validateIP(staticIP)) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å›ºå®šIPåœ°å€');
          return;
        }
      }

      try {
        console.log('ç™¼é€è«‹æ±‚åˆ° /save-config');
        const response = await fetch('/save-config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        console.log('æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹:', response.status);
        const result = await response.json();
        console.log('å›æ‡‰çµæœ:', result);

        if (result.success) {
          console.log('è¨­å®šæˆåŠŸï¼Œé¡¯ç¤ºå®Œæˆæ­¥é©Ÿ');
          // é¡¯ç¤ºå®Œæˆæ­¥é©Ÿ
          showStep(3);

          // å¦‚æœæ˜¯é¦–æ¬¡è¨­å®šï¼Œå•Ÿå‹•å®Œæˆæµç¨‹
          if (isFirstSetup) {
            startCountdown();
          } else {
            // éé¦–æ¬¡è¨­å®šï¼Œæç¤ºé‡æ–°å•Ÿå‹•
            document.getElementById('countdown').innerHTML =
              '<p>è¨­å®šå·²å„²å­˜ï¼Œè«‹æ‰‹å‹•é‡æ–°å•Ÿå‹•è¨­å‚™æˆ–ç­‰å¾…å¹¾åˆ†é˜å¾Œé‡æ–°è¨ªå•ã€‚</p>';
          }
        } else {
          alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
        }
      } catch (error) {
        console.error('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // é¦–æ¬¡è¨­å®šå®Œæˆå€’æ•¸
    function startCountdown() {
      let countdown = 3;
      const countdownElement = document.getElementById('countdown-number');
      const countdownInterval = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;

        if (countdown <= 0) {
          clearInterval(countdownInterval);
          completeSetup();
        }
      }, 1000);
    }

    // å®Œæˆé¦–æ¬¡è¨­å®š
    async function completeSetup() {
      console.log('å®Œæˆé¦–æ¬¡è¨­å®š');
      try {
        await fetch('/setup-complete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: 'complete=true'
        });

        console.log('è¨­å®šå®Œæˆï¼Œç­‰å¾…é‡å•Ÿ...');
        // ç­‰å¾…è¨­å‚™é‡å•Ÿ
        setTimeout(() => {
          window.location.href = 'http://192.168.4.1/';
        }, 5000);

      } catch (error) {
        console.log('è¨­å®šå®Œæˆï¼Œè¨­å‚™å°‡é‡æ–°å•Ÿå‹•');
        setTimeout(() => {
          window.location.href = 'http://192.168.4.1/';
        }, 5000);
      }
    }

    // IPåœ°å€é©—è­‰
    function validateIP(ip) {
      const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
      if (!ipPattern.test(ip)) return false;

      const parts = ip.split('.');
      for (let part of parts) {
        const num = parseInt(part);
        if (num < 0 || num > 255) return false;
      }
      return true;
    }

    // å¾ä¼ºæœå™¨ç²å–è¨­å®šå€¼
    async function loadConfigFromServer() {
      try {
        const response = await fetch('/status');
        const data = await response.json();

        // è¨­å®šè¨­å‚™åç¨±
        if (data.device_name) {
          document.getElementById('device_name').value = data.device_name;
        }

        // è¨­å®šAP SSID
        if (data.ap_ssid) {
          document.getElementById('ap_ssid').value = data.ap_ssid;
        }

        // æ›´æ–°é¦–æ¬¡è¨­å®šç‹€æ…‹
        isFirstSetup = data.first_setup === true || data.first_setup === 'true';

        console.log('å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®šå®Œæˆ, isFirstSetup:', isFirstSetup);

      } catch (error) {
        console.error('å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®šå¤±æ•—:', error);
      }
    }

    // åˆ‡æ›å¯†ç¢¼é¡¯ç¤º/éš±è—
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('wifi_password');
      const showBtn = document.getElementById('show-password');

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        showBtn.textContent = 'éš±è—';
      } else {
        passwordInput.type = 'password';
        showBtn.textContent = 'é¡¯ç¤º';
      }
    }

    // åˆå§‹åŒ–
    window.onload = async function () {
      console.log('é é¢è¼‰å…¥å®Œæˆ');

      // å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®š
      await loadConfigFromServer();

      // åˆå§‹åŒ–UIå…ƒç´ 
      toggleStaticFields();
      updateModeDescription();

      // äº‹ä»¶ç›£è½å™¨
      dhcpCheckbox.addEventListener('change', toggleStaticFields);
      networkModeSelect.addEventListener('change', updateModeDescription);

      // æ­¥é©ŸæŒ‰éˆ•äº‹ä»¶ç›£è½
      document.getElementById('next-step-1').addEventListener('click', () => nextStep(2));
      document.getElementById('prev-step-2').addEventListener('click', () => prevStep(1));
      document.getElementById('save-config-btn').addEventListener('click', saveConfiguration);

      // WiFiç›¸é—œæŒ‰éˆ•äº‹ä»¶ç›£è½
      document.getElementById('scan-wifi-btn').addEventListener('click', scanWiFi);
      document.getElementById('connect-btn').addEventListener('click', connectToWiFi);
      document.getElementById('cancel-connect').addEventListener('click', () => {
        document.getElementById('connection-form').classList.remove('show');
        selectedWiFi = null;
        document.querySelectorAll('.wifi-item').forEach(item => {
          item.classList.remove('selected');
        });
      });
      document.getElementById('show-password').addEventListener('click', togglePasswordVisibility);
      document.getElementById('disconnect-btn').addEventListener('click', disconnectWiFi);

      // é¡¯ç¤ºç¬¬ä¸€æ­¥
      console.log('é¡¯ç¤ºæ­¥é©Ÿ1, isFirstSetup:', isFirstSetup);
      showStep(1);

      // è‡ªå‹•åˆ·æ–°WiFiåˆ—è¡¨
      wifiScanInterval = setInterval(() => {
        if (currentStep === 2) {
          scanWiFi();
        }
      }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    };

    // æ¸…ç†å®šæ™‚å™¨
    window.addEventListener('beforeunload', () => {
      if (wifiScanInterval) {
        clearInterval(wifiScanInterval);
      }
    });
  </script>
</body>

</html>